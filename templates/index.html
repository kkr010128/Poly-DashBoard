<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="./static/style.css">
        <!-- <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    </head>
    <body>
        <div class="wrap">
            <div class="side_menu">
                <div class="side_banner">
                    <img src="./static/img/polygon_original_blue.png" style="width: 60%; height: 100%;">
                </div>
                <div class="menu_list">
                    <div class="line">
                        <img src="./static/img/icons/LINE.svg" style="width: 100%; height: 100%;">
                    </div>
                    <div class="menu">
                        <div class="wrap_img">
                            <img src="./static/img/icons/Tv.svg" style="width: 25px; height: 100%;">
                        </div>
                        <div class="menu_text">대시보드</div>
                    </div>
                    <div class="menu">
                        <div class="wrap_img">
                            <img src="./static/img/icons/Badge.svg" style="width: 25px; height: 100%;">
                        </div>
                        <div class="menu_text">라이센스 관리</div>
                    </div>
                    <div class="menu">
                        <div class="wrap_img">
                            <img src="./static/img/icons/App.svg" style="width: 25px; height: 100%;">
                        </div>
                        <div class="menu_text">리소스 관리</div>
                    </div>
                    <div class="menu">
                        <div class="wrap_img">
                            <img src="./static/img/icons/Single.svg" style="width: 25px; height: 100%;">
                        </div>
                        <div class="menu_text">고객 관리</div>
                    </div>
                    <div class="menu">
                        <div class="wrap_img">
                            <img src="./static/img/icons/Bullet-list.svg" style="width: 25px; height: 100%;">
                        </div>
                        <div class="menu_text">라이센스 로그</div>
                    </div>
                    <div class="menu">
                        <div class="wrap_img">
                            <img src="./static/img/icons/discord.svg" style="width: 25px; height: 100%;">
                        </div>
                        <div class="menu_text">봇 관리</div>
                    </div>
                    <div class="menu">
                        <div class="wrap_img">
                            <img src="./static/img/icons/users-filled.svg" style="width: 25px; height: 100%;">
                        </div>
                        <div class="menu_text">마이페이지</div>
                    </div>
                    <div class="line">
                        <img src="./static/img/icons/LINE.svg" style="width: 100%; height: 100%;">
                    </div>
                    <div class="menu">
                        <div class="wrap_img">
                            <img src="./static/img/icons/Bookmark.svg" style="width: 25px; height: 100%;">
                        </div>
                        <div class="menu_text">서비스 가이드</div>
                    </div>
                    <div class="menu">
                        <div class="wrap_img">
                            <img src="./static/img/icons/Diploma.svg" style="width: 25px; height: 100%;">
                        </div>
                        <div class="menu_text">POLYGON 규정</div>
                    </div>
                    <div class="menu">
                        <div class="wrap_img">
                            <img src="./static/img/icons/Gear.svg" style="width: 25px; height: 100%;">
                        </div>
                        <div class="menu_text">관리자 페이지</div>
                    </div>
                </div>
            </div>
            <div class="dash_board">
                <div class="top_area">
                    <div class="title_bar">
                        <div class="title">DASHBOARD</div>
                        <div class="user_profile">
                            <div class="profile_img" style="width: 25px; height: 25px; background-image: url('./static/img/polygon.png'); background-size: cover; background-position: center; border-radius: 50%;"></div>
                            <div class="profile_name">{UserName}</div>
                        </div>
                    </div>
                    <div class="card_section">
                        <div class="card_layer">
                            <div class="card">
                                <div class="higher">
                                    <div class="left_text_form">
                                        <div class="card_title">시스템 성능</div>
                                        <div class="card_inner_text" id="performance">CPU: {{ system_performance.cpu_usage }}%<br>RAM: {{ system_performance.memory_usage }}%</div>
                                    </div>
                                    <div class="right_img" style="background-image: url('./static/img/Button/stat.svg');"></div>
                                </div>
                                <div class="lower">
                                    <div class="footer_text">Uses</div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="higher">
                                    <div class="left_text_form">
                                        <div class="card_title">서버 트래픽</div>
                                        <div class="card_inner_text" id="traffic">Down: {{ network_stats.kbps_recv }}<br>Up: {{ network_stats.kbps_sent }}</div>
                                    </div>
                                    <div class="right_img" style="background-image: url('./static/img/Button/traffic.svg');"></div>
                                </div>
                                <div class="lower">
                                    <div class="footer_text">Kbps</div>
                                </div>
                            </div>
                        </div>
                        <div class="card_layer">
                            <div class="card">
                                <div class="higher">
                                    <div class="left_text_form">
                                        <div class="card_title">등록된 사용자</div>
                                        <div class="card_inner_text" id="performance">{{ user_counts }} 명</div>
                                    </div>
                                    <div class="right_img" style="background-image: url('./static/img/Button/users.svg');"></div>
                                </div>
                                <div class="lower">
                                    <div class="footer_text">Uses</div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="higher">
                                    <div class="left_text_form">
                                        <div class="card_title">리소스 판매량</div>
                                        <div class="card_inner_text" id="performance">{{ assigned_rsc }} 건</div>
                                    </div>
                                    <div class="right_img" style="background-image: url('./static/img/Button/Money.svg');"></div>
                                </div>
                                <div class="lower">
                                    <div class="footer_text">Uses</div>
                                </div>
                            </div>
                        </div>
                        <div class="card_layer">
                            <div class="card">
                                <div class="higher">
                                    <div class="left_text_form">
                                        <div class="card_title">등록된 라이센스</div>
                                        <div class="card_inner_text" id="performance">{{ license_cnt }} 건</div>
                                    </div>
                                    <div class="right_img" style="background-image: url('./static/img/Button/license.svg');"></div>
                                </div>
                                <div class="lower">
                                    <div class="footer_text">Uses</div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="higher">
                                    <div class="left_text_form">
                                        <div class="card_title">총 리소스</div>
                                        <div class="card_inner_text" id="performance">{{ uploaded_rsc_cnt }} 개</div>
                                    </div>
                                    <div class="right_img" style="background-image: url('./static/img/Button/total_rsc.svg');"></div>
                                </div>
                                <div class="lower">
                                    <div class="footer_text">Uses</div>
                                </div>
                            </div>
                        </div>
                        <div class="card_layer">
                            <div class="card">
                                <div class="higher">
                                    <div class="left_text_form">
                                        <div class="card_title">할당된 리소스</div>
                                        <div class="card_inner_text" id="performance">{{ license_rsc }} 개</div>
                                    </div>
                                    <div class="right_img" style="background-image: url('./static/img/Button/assigned.svg');"></div>
                                </div>
                                <div class="lower">
                                    <div class="footer_text">Uses</div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="higher">
                                    <div class="left_text_form">
                                        <div class="card_title">더미 리소스</div>
                                        <div class="card_inner_text" id="performance">{{ dummy_rsc_cnt }} 개</div>
                                    </div>
                                    <div class="right_img" style="background-image: url('./static/img/Button/dummy.svg');"></div>
                                </div>
                                <div class="lower">
                                    <div class="footer_text">Uses</div>
                                </div>
                            </div>
                        </div>
                        <div class="card_layer">
                            <div class="card_full">
                                <div class="chart_top">
                                    <div class="chart_title_1">OVERVIEW</div>
                                    <div class="chart_title_2">리소스별 실사용량</div>
                                </div>
                                <div class="chart_layer">
                                    <canvas id="chart1" class="can"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card_layer">
                            <div class="card_full">
                                <div class="chart_top">
                                    <div class="chart_title_1">OVERVIEW</div>
                                    <div class="chart_title_2">시간대별 API</div>
                                </div>
                                <div class="chart_layer">
                                    <canvas id="chart2" class="can"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card_layer">
                            <div class="card_full">
                                <div class="chart_top">
                                    <div class="chart_title_1">OVERVIEW</div>
                                    <div class="chart_title_2">리소스별 실사용량</div>
                                </div>
                                <div class="chart_layer">
                                    <canvas id="chart1" class="can"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card_layer">
                            <div class="card_full">
                                <div class="chart_top">
                                    <div class="chart_title_1">OVERVIEW</div>
                                    <div class="chart_title_2">시간대별 API</div>
                                </div>
                                <div class="chart_layer">
                                    <canvas id="chart2" class="can"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script> // 실시간 서버 정보 반영
            function updateStats() {
                fetch('/api/stats')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('traffic').innerHTML = `Down: ${data.network_stats.kbps_recv}<br>Up: ${data.network_stats.kbps_sent}`;
                        document.getElementById('performance').innerHTML = `CPU: ${data.system_performance.cpu_usage}%<br>RAM: ${data.system_performance.memory_usage}%`;
                    })
                    .catch(error => console.error('Error fetching stats:', error));
            }
            setInterval(updateStats, 3000); // 2초 간격으로 갱신
        </script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // 서버에서 전달된 JSON 데이터 파싱
                var dictModelCounts = JSON.parse('{{ dict_model_counts|safe }}');
                var labels = Object.keys(dictModelCounts); // 레이블(키) 추출
                var dataValues = Object.values(dictModelCounts); // 데이터 값 추출
    
                var ctx = document.getElementById('chart1').getContext('2d'); // 차트 영역 context 불러옴
                
                // 차트 데이터를 설정합니다.
                var data = {
                    labels: labels, // dict_model_counts의 키를 레이블로 설정
                    datasets: [{
                        label: '리소스 사용량',
                        data: dataValues, // dict_model_counts의 값을 데이터로 설정
                        backgroundColor: 'rgba(251, 99, 64, 0.8)',
                        radius: 50,
                        borderWidth: 2,
                        borderRadius: 100,
                        borderSkipped: false,
                        barPercentage: 0.7,
                        hoverBackgroundColor: 'rgba(251, 99, 64, 1)',
                        hoverBorderColor: 'rgba(251, 99, 64, 0.5)',
                    }]
                };
    
                // 차트 옵션을 설정합니다.
                var options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x', // 가로 막대 차트로 전환
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {drawOnChartArea: false}, // x 축 그리드 숨김
                            ticks: {color: 'white', font: {size: 8},},// y축 라벨 색상 흰색, 폰트 사이즈 조정
                        },
                        y: {
                            max: 30, // 차트 내 최댓값 표시 제한
                            ticks: {
                                color: 'white', // y축 라벨의 색상을 흰색으로 설정
                                font: {size: 8}
                            }
                        }
                    },
                    plugins: {
                        legend: {display: false},// 라벨을 표시하지 않음
                    },
                };
                // 차트 생성
                var myBarChart = new Chart(ctx, {
                    type: 'bar', // 차트 유형 (bar, line, pie 등)
                    data: data,
                    options: options,
                    //plugins: [ChartDataLabels],
                });
            });
        </script>
        <script>
            async function fetchData() {
                const response = await fetch('/api/chart-data');
                const result = await response.json();
                return result;
            }
        
            async function createChart() {
                const data = await fetchData();
                const ctx = document.getElementById('chart2').getContext('2d');
                const colors = [
                    {backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235, 1)', pointBackgroundColor: 'rgba(54, 162, 235, 1)'},
                    {backgroundColor: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgba(255, 99, 132, 1)', pointBackgroundColor: 'rgba(255, 99, 132, 1)'}
                ];
        
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: Object.keys(data.data).map((api, index) => ({
                            label: api,
                            data: data.data[api],
                            fill: true,
                            backgroundColor: colors[index % 2].backgroundColor,
                            borderColor: colors[index % 2].borderColor,
                            pointBackgroundColor: colors[index % 2].pointBackgroundColor,
                            tension: 0.4 // 곡선의 부드러움을 조절하는 속성 (0으로 설정하면 직선, 1로 설정하면 매우 부드러운 곡선)
                        }))
                    },
                    options: {
                        scales: {
                            r: {
                                angleLines: {
                                    color: 'white' // 그리드 선 색상
                                },
                                grid: {
                                    color: 'white' // 그리드 색상
                                },
                                pointLabels: {
                                    color: 'white' // 라벨 색상
                                },
                                ticks: {
                                    display: false // 척도 숨김
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // 범례 숨김
                            }
                        }
                    }
                });
            }
        
            window.onload = createChart;
        </script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    </body>
</html>